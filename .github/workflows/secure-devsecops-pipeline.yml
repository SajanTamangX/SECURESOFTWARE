name: DevSecOps Security Pipeline

# DevSecOps CI/CD Pipeline for Phishing Simulation & Awareness Portal
#
# This workflow implements a comprehensive security testing pipeline that runs on:
# - Every push to main/master branches
# - Every pull request
#
# Pipeline Stages:
#   1. Unit Tests - Runs Django test suite (required gate)
#   2. SAST (Semgrep) - Static code analysis for security vulnerabilities (required gate)
#   3. Dependency Scanning (pip-audit) - Checks for vulnerable Python packages (required gate)
#   4. Secret Scanning (Gitleaks) - Detects hardcoded secrets in code (required gate)
#   5. DAST (OWASP ZAP) - Dynamic application security testing (reporting only, non-blocking)
#
# Security Gates:
#   The following jobs act as "hard gates" that will fail the pipeline:
#   - test: Unit tests must pass
#   - sast_semgrep: No HIGH/CRITICAL security issues allowed
#   - dep_scan: No known vulnerabilities in dependencies
#   - secrets_scan: No hardcoded secrets allowed
#
#   The dast_zap_baseline job generates reports but does not block merges.
#   In a future iteration, we could parse ZAP JSON reports and fail on Medium/High findings.
#
# Branch Protection:
#   To enable branch protection in GitHub:
#   1. Go to Settings > Branches > Add rule
#   2. Select your branch (main/master)
#   3. Enable "Require status checks to pass before merging"
#   4. Select: test, sast_semgrep, dep_scan, secrets_scan
#   5. Save changes

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  # Job 1: Unit Tests
  # Runs Django test suite to ensure code functionality
  # Other security jobs depend on this to ensure we're testing working code
  test:
    name: Unit tests
    runs-on: ubuntu-latest
    
    services:
      db:
        image: postgres:16
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        # optional healthcheck - but we also explicitly wait below
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    env:
      GITHUB_ACTIONS: "true"
      DB_NAME: postgres
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: db
      DB_PORT: 5432
      DJANGO_SECRET_KEY: test-secret-key-for-ci
      DJANGO_DEBUG: 0
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Wait for PostgreSQL to be ready
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          echo "Waiting for PostgreSQL at db:5432..."
          for i in {1..20}; do
            if pg_isready -h db -p 5432 -U postgres -d postgres; then
              echo "Postgres is up!"
              break
            fi
            echo "Postgres is unavailable - sleeping"
            sleep 3
          done
          pg_isready -h db -p 5432 -U postgres -d postgres
      
      - name: Run migrations
        run: |
          cd phishing_portal
          python manage.py migrate --noinput
      
      - name: Run tests
        run: |
          cd phishing_portal
          python manage.py test

  # Job 2: SAST - Static Application Security Testing with Semgrep
  # Scans source code for security vulnerabilities using Semgrep rulesets
  # Fails pipeline if HIGH/CRITICAL issues are found
  sast_semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Semgrep
        run: pip install semgrep
      
      - name: Run Semgrep scan
        run: |
          semgrep scan \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/python \
            --config=p/django \
            --severity=ERROR \
            --error \
            --exclude="**/tests.py" \
            --exclude="**/test_*.py" \
            --exclude="**/*_test.py" \
            --exclude="**/test/**" \
            --exclude="**/migrations/**" \
            --exclude="**/venv/**" \
            --exclude="**/env/**" \
            --exclude="**/.venv/**" \
            --exclude="**/__pycache__/**" \
            --exclude="**/*.md" \
            --exclude="**/*.sql" \
            --exclude="**/db.sqlite3" \
            .

  # Job 3: Dependency Scanning with pip-audit
  # Scans Python dependencies for known vulnerabilities
  # Fails pipeline if vulnerabilities are found
  dep_scan:
    name: Dependency Scanning - pip-audit
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pip-audit
        run: pip install pip-audit
      
      - name: Run pip-audit scan
        run: |
          pip-audit -r requirements.txt --desc
        continue-on-error: false

  # Job 4: Secret Scanning with Gitleaks
  # Scans repository for hardcoded secrets, API keys, passwords, etc.
  # Fails pipeline if secrets are detected
  secrets_scan:
    name: Secret Scanning - Gitleaks
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Uses default Gitleaks configuration if .gitleaks.toml doesn't exist
          no-git: false
          verbose: true

  # Job 5: DAST - Dynamic Application Security Testing with OWASP ZAP
  # Runs OWASP ZAP baseline scan against running Django application
  # Generates HTML and JSON reports for analysis
  # This job does NOT fail the pipeline (reporting only)
  # Future enhancement: Parse JSON and fail on Medium/High findings
  dast_zap_baseline:
    name: DAST - ZAP Baseline
    runs-on: ubuntu-latest
    needs: test
    
    services:
      db:
        image: postgres:16
        env:
          POSTGRES_DB: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    env:
      GITHUB_ACTIONS: "true"
      DB_NAME: postgres
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: db
      DB_PORT: 5432
      DJANGO_SECRET_KEY: test-secret-key-for-ci
      DJANGO_DEBUG: 0
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Wait for PostgreSQL to be ready
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          echo "Waiting for PostgreSQL at db:5432..."
          for i in {1..20}; do
            if pg_isready -h db -p 5432 -U postgres -d postgres; then
              echo "Postgres is up!"
              break
            fi
            echo "Postgres is unavailable - sleeping"
            sleep 3
          done
          pg_isready -h db -p 5432 -U postgres -d postgres
      
      - name: Run migrations and start server
        run: |
          cd phishing_portal
          python manage.py migrate --noinput
          nohup python manage.py runserver 0.0.0.0:8000 &
          sleep 10
      
      - name: Make ZAP script executable
        run: chmod +x security/run_zap_baseline.sh
      
      - name: Run ZAP Baseline
        run: |
          bash security/run_zap_baseline.sh http://localhost:8000 || true
      
      - name: Upload ZAP report artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-report
          path: security/reports/*
