# Docker Compose configuration for Production Environment
# This file defines services optimized for production deployment
# Usage: docker-compose -f docker-compose.prod.yml up -d

services:
  # PostgreSQL Database Service (Production)
  # Configured with health checks and automatic restarts
  db:
    # Use official PostgreSQL 16 image
    image: postgres:16
    # Environment variables with defaults (can be overridden via .env.production)
    # ${VAR:-default} syntax provides fallback values
    environment:
      POSTGRES_DB: ${DB_NAME:-phishing_db}                    # Database name from env or default
      POSTGRES_USER: ${DB_USER:-phishing_user}                 # Database user from env or default
      POSTGRES_PASSWORD: ${DB_PASSWORD:-phishing_pass}        # Database password from env or default
    # Persistent volume for database data
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Automatically restart container if it stops (unless manually stopped)
    restart: unless-stopped
    # Health check to ensure database is ready before web service starts
    # Checks if PostgreSQL is accepting connections
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-phishing_user}"]  # Command to check database readiness
      interval: 10s    # Check every 10 seconds
      timeout: 5s      # Timeout after 5 seconds
      retries: 5       # Retry 5 times before marking as unhealthy

  # Django Web Application Service (Production)
  # Uses Gunicorn WSGI server instead of Django dev server for better performance
  web:
    # Build configuration for production image
    build:
      context: .                                    # Build context (current directory)
      dockerfile: Dockerfile.production            # Use production Dockerfile
    # Run Gunicorn WSGI server (production-ready web server)
    # --workers 3: Run 3 worker processes for handling requests
    # --timeout 120: Request timeout of 120 seconds
    command: gunicorn --bind 0.0.0.0:8000 --workers 3 --timeout 120 phishing_portal.wsgi:application
    # Mount volume for static files (CSS, JS, images)
    # Static files are collected during build and served from this volume
    volumes:
      - static_volume:/app/phishing_portal/staticfiles
    # Expose application port
    ports:
      - "8000:8000"  # Access application at http://localhost:8000
    # Load production environment variables
    env_file:
      - .env.production
    # Production environment variables
    environment:
      - DJANGO_PRODUCTION=1    # Enable production security settings
      - DJANGO_DEBUG=0         # Disable debug mode for security
    # Wait for database to be healthy before starting
    # This ensures database is ready to accept connections
    depends_on:
      db:
        condition: service_healthy  # Only start when db healthcheck passes
    # Automatically restart container if it stops
    restart: unless-stopped

# Named volumes for data persistence
# These volumes persist data even when containers are removed
volumes:
  postgres_data:      # Stores PostgreSQL database files
  static_volume:      # Stores Django static files (CSS, JS, images)

