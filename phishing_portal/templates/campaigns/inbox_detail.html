{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">

    <!-- Email header -->
    <div style="
        background:#ffffff;
        border-radius:8px;
        padding:18px 20px;
        border:1px solid #e1e1e1;
        margin-bottom:18px;
        box-shadow:0 6px 18px rgba(15, 23, 42, 0.06);
    ">
        <div style="
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap:12px;
        ">
            <!-- Subject + meta -->
            <div style="flex:1 1 auto;">
                <div style="font-size:20px; font-weight:600; margin-bottom:8px; color:#111827;">
                    {{ email.subject }}
                </div>

                <div style="font-size:13px; color:#4b5563; margin-bottom:2px;">
                    <strong>From:</strong>
                    Indigo Accounts &lt;no-reply@securesoftware.local&gt;
                </div>

                <div style="font-size:13px; color:#4b5563; margin-bottom:2px;">
                    <strong>To:</strong>
                    {{ email.recipient.recipient.email }}
                </div>

                <div style="font-size:13px; color:#6b7280;">
                    <strong>Date:</strong>
                    {{ email.sent_at|date:"M j, Y, g:i a" }}
                </div>
            </div>

            <!-- Actions (3-dot menu) -->
            <div class="ns-email-header-actions" style="flex:0 0 auto; position:relative;">
                <button
                    type="button"
                    class="ns-email-menu-toggle"
                    aria-haspopup="true"
                    aria-expanded="false"
                    style="
                        border:none;
                        background:transparent;
                        cursor:pointer;
                        padding:4px 6px;
                        border-radius:999px;
                        line-height:1;
                        font-size:20px;
                        color:#6b7280;
                    "
                    title="More actions"
                >
                    â‹®
                </button>

                <div
                    class="ns-email-menu"
                    style="
                        position:absolute;
                        top:120%;
                        right:0;
                        min-width:210px;
                        background:#ffffff;
                        border-radius:8px;
                        border:1px solid #e5e7eb;
                        box-shadow:0 10px 30px rgba(15, 23, 42, 0.15);
                        padding:6px 0;
                        display:none;
                        z-index:20;
                    "
                >
                    <button
                        type="button"
                        class="ns-email-view-headers"
                        style="
                            display:block;
                            width:100%;
                            text-align:left;
                            padding:8px 12px;
                            font-size:13px;
                            background:none;
                            border:none;
                            cursor:pointer;
                        "
                    >
                        ðŸ“¬ View raw headers
                    </button>

                    <a
                        href="{% url 'campaigns:track_report' email.recipient.tracking_id %}"
                        style="
                            display:block;
                            padding:8px 12px;
                            font-size:13px;
                            color:#b91c1c;
                            text-decoration:none;
                        "
                    >
                        ðŸš© Report this email as suspicious
                    </a>
                </div>
            </div>
        </div>

        <!-- Collapsible headers panel -->
        <div id="ns-headers-panel"
             style="
                margin-top:12px;
                display:none;
                border-radius:6px;
                background:#f9fafb;
                border:1px dashed #d1d5db;
                padding:10px 12px;
                font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
                font-size:11px;
                color:#111827;
                white-space:pre-wrap;
             ">
From: Indigo Accounts <no-reply@securesoftware.local>
To: {{ email.recipient.recipient.email }}
Subject: {{ email.subject }}
Date: {{ email.sent_at|date:"D, d M Y H:i:s O" }}
X-Campaign-Name: {{ email.campaign.name }}
X-Tracking-ID: {{ email.recipient.tracking_id }}
X-Portal: NepSoftware Security Training
        </div>
    </div>

    <!-- Email body -->
    <div style="margin-top:10px;">
        {% if email.body_html %}
            {{ email.body_html|safe }}
        {% else %}
            {{ email.body_text|urlize|linebreaksbr }}
        {% endif %}
    </div>
</div>

<script>
  (function () {
    var container = document.querySelector('.ns-email-header-actions');
    if (!container) return;

    var toggle = container.querySelector('.ns-email-menu-toggle');
    var menu   = container.querySelector('.ns-email-menu');
    var viewHeadersBtn = container.querySelector('.ns-email-view-headers');
    var headersPanel   = document.getElementById('ns-headers-panel');
    var body = document.body;

    if (!toggle || !menu) return;

    // Open / close 3-dot menu
    toggle.addEventListener('click', function (e) {
      e.stopPropagation();
      var isOpen = menu.style.display === 'block';
      menu.style.display = isOpen ? 'none' : 'block';
      toggle.setAttribute('aria-expanded', String(!isOpen));
    });

    // Toggle headers panel
    if (viewHeadersBtn && headersPanel) {
      viewHeadersBtn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        var isVisible = headersPanel.style.display === 'block';
        headersPanel.style.display = isVisible ? 'none' : 'block';
      });
    }

    // Close menu on outside click
    document.addEventListener('click', function () {
      menu.style.display = 'none';
      toggle.setAttribute('aria-expanded', 'false');
    });
  })();
</script>

<style>
/* Dark mode support for inbox detail */
body.ns-dark div[style*="background:#ffffff"] {
  background: #1e293b !important;
  border-color: rgba(255,255,255,0.1) !important;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3) !important;
}

body.ns-dark div[style*="color:#111827"] {
  color: #f1f5f9 !important;
}

body.ns-dark div[style*="color:#4b5563"] {
  color: #cbd5e1 !important;
}

body.ns-dark div[style*="color:#6b7280"] {
  color: #9ca3af !important;
}

body.ns-dark button[style*="color:#6b7280"] {
  color: #9ca3af !important;
}

body.ns-dark button[style*="color:#6b7280"]:hover {
  color: #cbd5e1 !important;
  background: rgba(255,255,255,0.05) !important;
}

body.ns-dark .ns-email-menu {
  background: #1e293b !important;
  border-color: rgba(255,255,255,0.1) !important;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
}

body.ns-dark .ns-email-menu button,
body.ns-dark .ns-email-menu a {
  color: #e2e8f0 !important;
}

body.ns-dark .ns-email-menu button:hover,
body.ns-dark .ns-email-menu a:hover {
  background: rgba(255,255,255,0.05) !important;
}

body.ns-dark .ns-email-menu a[style*="color:#b91c1c"] {
  color: #f87171 !important;
}

body.ns-dark #ns-headers-panel {
  background: #0f172a !important;
  border-color: rgba(255,255,255,0.1) !important;
  color: #e2e8f0 !important;
}
</style>

{% endblock %}
